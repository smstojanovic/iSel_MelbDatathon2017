---
title: "R Notebook"
output: html_document
---

```{r setup}
library(tidyverse)
library(readr)
library(magrittr)
library(data.table)
library(dtplyr)
library(feather)
library(lubridate)
```


```{r}
data_dir <- "../data/"
t_dir <- paste0(data_dir, "Transactions/")
t_files <- dir(t_dir)

lookup_dir <- paste0(
  data_dir,
  "Lookups/")

lookup_data <- list()
lookup_files <- dir(lookup_dir)
```

```{r}
# transactions <- read_feather("../data/transactions.feather")
# fwrite(transactions, file = "../data/transactions_consolidated.csv", sep = ";")
# t_files %>%
#   map_df(~fread(
#     file = paste0(t_dir, .))) ->
#   transactions
# 
# fwrite(transactions, file = "../data/transactions_consolidated.csv", sep = ";")
# 
lookup_files %>%
  map(~fread(
    file = paste0(lookup_dir, .)
  )) %>%
  walk2(.y = list("atc", "chronic_illnesses", "drugs", "patients", "stores"), ~assign(x = .y, value = .x))
```


```{r}
# datathon_db <- src_postgres(dbname = "datathon")
#   transactions %>% slice(0),
#   name = "transactions",
#   temporary = FALSE)
```


```{r}
# datathon_db <- src_postgres(dbname = "datathon")
# 
# 
# copy_to(
#   datathon_db,
#   transactions %>% slice(0),
#   name = "transactions",
#   temporary = FALSE)
# 
# lookups %>%
#   map2(.y = names(.), ~copy_to(
#     dest = datathon_db,
#     df = .,
#     name = .y,
#     temporary = FALSE
#   ))
```
```{r}
db <- src_postgres(dbname = "datathon")
db %>% 
  tbl("transactions") %>% 
  count(Patient_ID) %>% 
  count(n)
```
# t_tbl <- tbl(db, "transactions")
# t_tbl %>% 
#   count(Prescriber_ID) %>% 
#   count(n) %>% 
#   View
```
```{r}
# t_tbl %>% 
#   count(Prescription_Week) %>% 
#   collect(n = Inf) -> 
#   weekly_prescription_numbers
```

```{r}
# weekly_prescription_numbers %>% 
  # mutate(Prescription_Week = ymd(Prescription_Week)) %>% 
  # ggplot(aes(x = Prescription_Week, y = n)) +
  # geom_line()
```

```{r}
transactions <- read_feather("../data/transactions.feather")
```

```{r}
transactions %>% 
  count(Store_ID) %>% 
  ggplot(aes(x = n)) +
  geom_histogram()
```
```{r}
transactions %>% 
  count(Prescriber_ID) %>% 
  filter(n > 1e4) %>% 
  View
```
```{r}
transactions %>% 
  count(Prescriber_ID) %>% 
  filter(n > 1e2) %>%
  nrow
```
```{r}
transactions %>% 
  count(Patient_ID) %>% 
  filter(n > 100) %>% 
  nrow
```

```{r}
transactions %>% 
  semi_join(
    lookups$patients %>% 
      filter(year_of_birth != "1900"),
    by = "Patient_ID"
  ) %>% 
  count(Patient_ID) %>% 
  filter(n > 100) %>% 
  ggplot(aes(x = n)) +
  geom_histogram(bins = 100)
```

```{r}
lookups %>%
  map(as.data.table) -> 
  lookups

setDT(transactions)

transactions %>% 
  sample_frac(0.1) %>% 
  left_join(lookups$drugs %>% 
              rename(Drug_Code = MasterProductCode), 
            by = "Drug_Code") %>% 
  left_join(lookups$atc,
            by = "ATCLevel5Code") -> 
  tmp

